#!/bin/bash

set -e

apt-get update
apt-get install -y git ruby ruby-dev libmysqlclient-dev libpq-dev libevent-dev libxml2-dev libxslt1-dev libreadline-dev build-essential
lsb_release -a | grep Ubuntu || debian=true
if [[ $debian = true ]]; then
  apt-get install -y rubygems
fi

cd /opt
if [[ -d pkgr ]]; then
  cd pkgr
  git pull
else
  git clone https://github.com/seven1m/pkgr.git
  cd pkgr
fi
chown -R vagrant /opt/pkgr

gem install bundler --no-rdoc --no-ri
bundle install

grep "pkgr" /home/vagrant/.bashrc || echo "PATH=/opt/pkgr/bin:\\$PATH" >> /home/vagrant/.bashrc

mkdir -p /tmp/pkgr-cache
chown -R vagrant /tmp/pkgr-cache

echo "Great! Now run: ./deb_build"
