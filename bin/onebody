#!/usr/bin/env ruby

require 'fileutils'
require 'highline/import'


if directory = File.expand_path(ARGV[0])

  if NEW_INSTALL = !File.exists?(directory)
    puts "Creating a new instance of OneBody at #{directory}"
    FileUtils.mkdir(directory)
  else
    puts "Upgrading your instance of OneBody at #{directory}"
  end

  # copy files
  %w(deploy/config deploy/db deploy/lib deploy/log deploy/script deploy/Rakefile public themes).each do |dir|
    begin
      FileUtils.cp_r(File.join(File.dirname(__FILE__), "../#{dir}"), directory, :remove_destination => true)
    rescue => e
      if dir == 'deploy/db' # the gem is missing the deploy/db directory - I don't know why
        FileUtils.mkdir(File.join(directory, 'db'))
      else
        puts "There was an error copying files: #{e}"
        exit(1)
      end
    end
  end
  
  # copy and tweak some Rails files
  [ # orig, dest, hash_of_gsub_changes
  
    [ File.join(File.dirname(__FILE__), '../vendor/rails/railties/lib/commands/console.rb'),
      File.join(directory, 'lib/commands/console.rb'),
      {/#\{RAILS_ROOT\}\/config\/environment/ => '#{APP_ROOT}/config/environment'} ],
      
    [ File.join(File.dirname(__FILE__), '../vendor/rails/railties/lib/commands/server.rb'),
      File.join(directory, 'lib/commands/server.rb'),
      {/require "commands\/servers\/#\{server\}"/ => 'require APP_ROOT + "/lib/commands/servers/webrick"',
       /\|dir_to_make\| FileUtils\.mkdir_p\(File\.join\(RAILS_ROOT, 'tmp', dir_to_make\)\)/ => "|dir_to_make| FileUtils.mkdir_p(File.join(APP_ROOT, 'tmp', dir_to_make))"} ],
      
    [ File.join(File.dirname(__FILE__), '../vendor/rails/railties/lib/commands/servers/webrick.rb'),
      File.join(directory, 'lib/commands/servers/webrick.rb'),
      {/require RAILS_ROOT \+ "\/config\/environment"/ => 'require APP_ROOT + "/config/environment"'} ]
      
  ].each do |orig, dest, changes|
    src = File.read(orig)
    changes.each { |from, to| src.gsub!(from, to) }
    File.open(dest, 'w') { |f| f.write src }
  end
  
  puts "Done copying files.\n\n"
  
  # create the database config file if it doesn't exist yet
  unless File.exists? File.join(directory, "config/database.yml")
    puts 'Setting up the database configuration...'
    begin
      db_adapter = ask('Choose your database type (sqlite or mysql) [sqlite]: ')
      db_adapter = 'sqlite' unless db_adapter.any?
    end while not %w(sqlite mysql).include? db_adapter
    case db_adapter
    when 'sqlite'
      config = "production:\n  adapter: sqlite3\n  database: db/onebody.db"
    when 'mysql'
      puts 'Enter the MySQL username and password.'
      db_user = ask('Username [root]: ')
      db_user = 'root' unless db_user.any?
      db_pass = ask('Password [blank]: ') { |q| q.echo = false }
      db_name = ask('Database name [onebody]: ')
      db_name = 'onebody' unless db_name.any?
      config = "production:\n  adapter: mysql\n  database: #{db_name}\n  username: #{db_user}\n  password: #{db_pass}"
    end
    File.open(File.join(directory, 'config/database.yml'), 'w') { |f| f.write config }
    puts
  end  
  
  puts 'Now, cd to your instance directory and run the following command:'
  if NEW_INSTALL
    puts 'rake init'
  else
    puts 'rake update'
  end
  
else
  
  puts 'Usage: onebody /path/to/deploy'
  
end