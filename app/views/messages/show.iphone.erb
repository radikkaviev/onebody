<% content_for :toolbar do %>
  <h1><%= t('messages.message_view') %></h1>
  <%= iphone_back_button %>
<% end %>

<div class="info">
  <table><tr><td style="padding-right:5px;">
    <a href="<%= url_for @message.person %>">
      <%= render :partial => 'people/thumbnail', :locals => {:person => @message.person} %>
    </a>
  </td><td>
  <%= image_tag 'comment.gif', :alt => t('messages.message'), :class => 'icon' %>
  <%= t('messages.message_by') %> <%= link_to @message.person.name, @message.person %><br/>
  <%= @message.created_at.strftime '%B %d, %Y %I:%M %p' %>
  </td></tr></table>
</div>

<h2>
  <%= @message.subject %>
  <% if @message.wall %>
    <%= t('messages.messages_on') %> <%= @message.wall.name %>
  <% end %>
</h2>

<div class="body">
  <% if @message.html_body.to_s.any? %>
    <p><%= white_list_with_removal(hide_contact_details(@message.html_body)) %></p>
  <% else %>
    <p><%= preserve_breaks(remove_excess_breaks(hide_contact_details(@message.body))) %></p>
  <% end %>
</div>

<% if @message.attachments.any? %>
  <h2><%= t('messages.attachments') %>:</h2>
  <ul>
    <% @message.attachments.each do |attachment| %>
      <li>
        <%= link_to image_tag('attachment.gif', :alt => t('messages.attachment'), :class => 'icon'), [@message, attachment] %>
        <%= link_to attachment.name, [@message, attachment] %>
        (<%= number_to_human_size(attachment.file_size) rescue t('messages.file_missing') %>)
      </li>
    <% end %>
  </ul>
<% end %>

<ul>
  <% @message.children.each do |reply| %>
    <li>
      <div>
        <%= render :partial => 'people/thumbnail', :locals => {:person => reply.person} %>
        <%= image_tag 'comment.gif', :alt => t('messages.reply'), :class => 'icon' %>
        <%= t('messages.reply_by') %> <%= link_to reply.person.name, reply.person %><br/>
        <%= reply.created_at.strftime '%B %d, %Y %I:%M %p' %>
      </div>
      <p>
        <% if reply.html_body.to_s.any? %>
          <%= white_list(hide_contact_details(reply.html_body)) %>
        <% elsif params[:show_quoted] %>
          <%= preserve_breaks(remove_excess_breaks(hide_contact_details(reply.body))) %>
        <% else %>
          <% trimmed = remove_bulk_quoting(hide_contact_details(reply.body)) %>
          <%= preserve_breaks(remove_excess_breaks(trimmed)) %>
          <% if reply.body.split(/\n/).length != trimmed.split(/\n/).length %>
            <br/>
            <em style="color:#009;">
              <%= t('messages.some_quoted_text_is_hidden') %>
              <%= link_to t('click_here'), :show_quoted => true %>
              <%= t('messages.to_show_the_entire_message') %>
            </em>
          <% end %>
        <% end %>
      </p>
      <% if @message.attachments.any? %>
        <h2><%= t('messages.attachments') %>:</h2>
        <ul>
          <% @message.attachments.each do |attachment| %>
            <li>
              <%= link_to image_tag('attachment.gif', :alt => t('messages.attachment'), :class => 'icon'), [@message, attachment] %>
              <%= link_to attachment.name, [@message, attachment] %>
              (<%= number_to_human_size(attachment.file_size) rescue t('messages.file_missing') %>)
            </li>
          <% end %>
        </ul>
      <% end %>
    </div>
  <% end %>

  <% if @message.group and @message.group.can_post? @logged_in %>
    <li class="arrow"><%= link_to t('messages.reply_to_this_message'), new_message_path(:parent_id => @message.id) %></li>
  <% end %>
</ul>
