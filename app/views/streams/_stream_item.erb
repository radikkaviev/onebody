<div class="stream-item stream_<%= stream_item.streamable_type.underscore %>">
  <div class="stream-item-meta">
    <% if stream_item.person %>
      <span class="nowrap">
        <a href="<%= url_for stream_item.person %>">
          <%= render :partial => 'people/thumbnail', :locals => {:person => stream_item.person} %>
        </a>
        <%= link_to h(stream_item.person.name), stream_item.person %>
        <br/>
      </span>
    <% end %>
    <% if stream_item.group %>
      <span class="nowrap">
        in <%= link_to h(stream_item.group.name), stream_item.group %>
      </span>
      <br/>
    <% end %>
    <span class="nowrap stream-item-timestamp">
      <%= time_ago_in_words stream_item.created_at %> ago
    </span>
    <div style="clear:left;"></div>
  </div>
  <div class="stream-item-body">
    <h2>
      <%= link_to stream_icon(stream_item), stream_item %>
      <%= link_to h(stream_item.title), stream_item %>
    </h2>
    <% if stream_item.body %>
      <%= white_list_with_removal(stream_item.body) %>
    <% elsif stream_item.context.any? %>
      <% stream_item.context['picture_ids'].each do |picture_id| %>
        <%= link_to image_tag(small_album_picture_photo_path(stream_item.streamable_id, picture_id), :alt => 'click to enlarge', :class => 'stream-pic'),
          album_picture_path(stream_item.streamable_id, picture_id), :title => 'click to enlarge' %>
      <% end %>
    <% end %>
    <% if stream_item.context['comments'].to_a.any? %>
      <table>
        <% stream_item.context['comments'].to_a.each do |comment| %>
          <% if person = Person.find(comment['person_id'], :select => 'first_name, last_name, suffix, id, family_id, updated_at') %>
            <tr class="stream-item-comment">
              <td style="text-align:right;">
                <a href="<%= url_for person %>">
                  <%= render :partial => 'people/thumbnail', :locals => {:person => person} %>
                </a>
              </td>
              <td>
                <%=h comment['text'] %>
                <span class="stream-item-timestamp">
                  <%= time_ago_in_words(comment['created_at']) %> ago
                </span>
              </td>
            </tr>
          <% end %>
        <% end %>
      </table>
    <% end %>
  </div>
</div>
